port code from https://github.com/andrej-kolic-sm
